services:
  system_manager:
    container_name: system_manager
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    network_mode: host
    volumes:
      # Mount agent sockets directory (read-only for system_manager)
      # Path is relative to this docker-compose.yml location
      # Each container's socket is mounted to /agents/{container_name}
      - ../ai_worker/docker/agent_sockets/ai_worker:/agents/ai_worker
      - ../physical_ai_tools/docker/agent_sockets/physical_ai_server:/agents/physical_ai_server
      # Mount config file
      - ./config.yml:/app/config.yml
      # Mount Docker socket for Docker API access
      - /var/run/docker.sock:/var/run/docker.sock
      - ./system_manager:/app/system_manager
    environment:
      - CONFIG_FILE=/app/config.yml
    # Note: This service can run independently, but requires agent sockets
    # to be created by the ai_worker container first

  ui:
    container_name: system_manager_ui
    build:
      context: ./system_manager_ui
      dockerfile: Dockerfile.dev
    restart: always
    network_mode: host
    volumes:
      # Mount source code for hot-reload in development
      - ./system_manager_ui:/app
      # Exclude node_modules from host to use container's node_modules
      - /app/node_modules
      # Exclude .next build cache from host
      - /app/.next
    environment:
      - NEXT_PUBLIC_API_URL=http://127.0.0.1:8081
      - NODE_ENV=development
    # Note: UI uses host network mode to communicate with system_manager
    # If system_manager is on a Docker network, change network_mode and
    # set NEXT_PUBLIC_API_URL to http://system_manager:8081
